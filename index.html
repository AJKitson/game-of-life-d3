<!DOCTYPE html>
<html>
  <head>
    <script src="bower_components/d3/d3.min.js" charset="utf-8"></script>
    <script src="bower_components/underscore/underscore-min.js" charset="utf-8"></script>
    <script src="CellPopulation.js"></script>
    <style type="text/css">
      svg {
        border: 1px solid #666;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
    /*TODO
    - add click
    - have color be brighter on creation, gray as it ages (e.g. for static formations)
    - maybe have background color change with the number of cells
    - add fading color on remove
    - allow panning 
    - allow zooming 
    - do pan and zoom automatically
    - switch to d3 timer // maybe not?? -- not for updating w/new data?
    - switch to d3 scales
    - clean up: global variables, not creating all our helper fns w/each tick, etc.
    - create buttons to add standard formations
    - implement CellPopulation as a SICP-style stream of generations
    */
      var createNewGeneration = function (world) {
        var livingNeighborCount = function (cell) {
          return world.getNeighbors(cell)
            .filter(world.isAlive)
            .length;
        };

        var aliveInNextGeneration = function (cell) {
          var livingNeighbors = livingNeighborCount(cell);
          return world.isAlive(cell) 
                 ? livingNeighbors === 2 || livingNeighbors === 3
                 : livingNeighbors === 3;
        };

        var newSeed = world.liveCellsAndNeighbors().filter(aliveInNextGeneration);
        return CellPopulation(newSeed);
      };

      var scaleCoordUp = function (c) {
        return settings.cellSize * c + settings.cellSize / 2;
      }  

      var display = function (cells) {
        var size = settings.cellSize;
        var cells = d3.select('svg')
          .selectAll('circle')
          .data(cells, function (d) { return d; })
          .style('fill', '#45e')
          

        cells.enter()
          .append('circle')
          .attr('class', 'cell')
          .attr('r', size / 2 + 'px')
          .attr('cx', function (d) { return scaleCoordUp(d[0]) + 'px'; }) //what was I thinking here?
          .attr('cy', function (d) { return scaleCoordUp(d[1]) + 'px'; })

        cells.exit()
          //.remove();
          .style('fill', '#ccc') //just leave around, 
      };

      var wheelOfTime = function (world) {
        display(world.liveCells());
        setTimeout(function () {
        // d3.timer(function () { //d3.timer is sticky...
          settings.world = createNewGeneration(world);
          wheelOfTime(settings.world);
        }, settings.tick); 
        return false;
      };

      // var coordsToCell = function (x, y) {
      //   var scaleDown = function (c) { return Math.floor(x / settings.cellSize); }
      //   return [scaleDown(x), scaleDown(y)];
      // }
    
      var settings = {
        cellSize: 10,
        worldSize: 1000,
        world: {},
        tick: 50
      };
      //initial setup
      d3.select('body').append('svg')
        .attr('width', settings.worldSize + 'px')
        .attr('height', settings.worldSize + 'px')
        // .on('click', function (e) {
        //   var xy = d3.mouse(this);
        //   var cell = coordsToCell(xy[0], xy[1]);
        //   settings.world.addCell(cell);
        // })

      var seed = [[5, 5], [6, 5], [6, 3], [8, 4], [9, 5], [10, 5], [11, 5]];
      seed = seed.map(function (cell) {  //position at middle (hacky...)
        return [
          cell[0] + (settings.worldSize / 2) / settings.cellSize, 
          cell[1] + (settings.worldSize / 2) / settings.cellSize
        ]; 
      });

      var world = CellPopulation(seed) //need access to world in click handler, so have it out here somewhere
      wheelOfTime(world);

    </script>
  </body>
</html>
